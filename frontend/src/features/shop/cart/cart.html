<div class="cart-page">
  <!-- st√°tuszok -->
  @if(loading()){<section class="status">Bet√∂lt√©s‚Ä¶</section>}
  @if(error()){<section class="status error">Hiba: {{ error() }}</section>}

  <!-- √ºres √°llapot -->
  @if(!loading() && !items().length){<section class="empty-cart">
    <div class="empty-content">
      <div class="empty-icon">üõí</div>
      <h2>A kosarad √ºres</h2>
      <p>M√©g nem adt√°l hozz√° term√©ket a kosaradhoz.</p>
      <a href="/shop" class="shop-btn">B√∂ng√©sz√©s a webshopban</a>
    </div>
  </section>}

  <!-- sorok csak akkor, ha van t√©tel -->
  @if(!loading() && items().length){<section class="wrap head">
    <h1>Rendel√©s</h1>
    <h2>Kos√°r tartalma</h2>

    <div class="lines">
      @for(it of items(); track trackById($index, it)){<div
        class="line"
        [class.busy]="isPending(it.id)"
        [attr.aria-busy]="isPending(it.id) ? 'true' : 'false'"
      >
        <div class="prod">
          <img [src]="it.imageUrl" [alt]="it.name" />
          <div class="meta">
            <div class="title">{{ it.name }}</div>
            @if(it.subtitle){<div class="sub">{{ it.subtitle }}</div>}
          </div>
        </div>

        <div class="qty">
          <button
            type="button"
            class="qbtn"
            (click)="dec(it.id)"
            [disabled]="isPending(it.id)"
            [attr.aria-label]="'Mennyis√©g cs√∂kkent√©se: ' + it.name"
          >‚àí</button>

          <div class="qval">{{ it.qty }}</div>

          <button
            type="button"
            class="qbtn"
            (click)="inc(it.id)"
            [disabled]="isPending(it.id)"
            [attr.aria-label]="'Mennyis√©g n√∂vel√©se: ' + it.name"
          >+</button>
        </div>

        <div class="price">{{ (it.unitPrice * it.qty) | number:'1.0-0' }} Ft</div>

        <button
          type="button"
          class="trash"
          aria-label="T√∂rl√©s"
          (click)="remove(it.id)"
          [disabled]="isPending(it.id)"
          [attr.aria-label]="'T√©tel t√∂rl√©se: ' + it.name"
        >
        <mat-icon>delete</mat-icon>
      </button>
      </div>}
    </div>

    <div class="total">
      <div class="label">V√©g√∂sszeg:</div>
      <div class="value">{{ total() | number:'1.0-0' }} Ft</div>
    </div>
  </section>}

  <!-- Adatok / ≈±rlap blokk (marad vizu√°lis) -->
  @if(!loading() && items().length){<section class="checkout">
    <div class="wrap">
      <h3>Adatok</h3>
      <form class="form" [formGroup]="orderForm" (ngSubmit)="onSubmitOrder()">
        <div class="row">
          <input 
            type="text" 
            placeholder="N√©v *" 
            class="input full" 
            formControlName="customerName"
            [class.error]="orderForm.get('customerName')?.invalid && orderForm.get('customerName')?.touched"
          />
        </div>
        <div class="row">
          <input 
            type="text" 
            placeholder="Ad√≥sz√°m (c√©g eset√©n k√∂telez≈ë)" 
            class="input full" 
            formControlName="customerTaxId"
          />
        </div>
        <div class="row">
          <input 
            type="tel" 
            placeholder="Telefon *" 
            class="input" 
            formControlName="customerPhone"
            [class.error]="orderForm.get('customerPhone')?.invalid && orderForm.get('customerPhone')?.touched"
          />
          <input 
            type="email" 
            placeholder="E-mail *" 
            class="input" 
            formControlName="customerEmail"
            [class.error]="orderForm.get('customerEmail')?.invalid && orderForm.get('customerEmail')?.touched"
          />
        </div>
        <h4>Sz√°ml√°z√°si c√≠m</h4>
        <div class="row">
          <input 
            type="text" 
            placeholder="Ir√°ny√≠t√≥sz√°m *" 
            class="input" 
            formControlName="billingZip"
            [class.error]="orderForm.get('billingZip')?.invalid && orderForm.get('billingZip')?.touched"
          />
          <input 
            type="text" 
            placeholder="Telep√ºl√©s *" 
            class="input" 
            formControlName="billingCity"
            [class.error]="orderForm.get('billingCity')?.invalid && orderForm.get('billingCity')?.touched"
          />
        </div>
        <div class="row">
          <input 
            type="text" 
            placeholder="Utca, h√°zsz√°m *" 
            class="input" 
            formControlName="billingAddress"
            [class.error]="orderForm.get('billingAddress')?.invalid && orderForm.get('billingAddress')?.touched"
          />
        </div>

        <label class="shipToDifferent">
          <input
            type="checkbox"
            formControlName="differentDeliveryAddress"
          />
          Sz√°ll√≠t√°s m√°sik c√≠mre
        </label>
        @if(orderForm.get('differentDeliveryAddress')?.value){<h4>Sz√°ll√≠t√°si c√≠m</h4>}
        @if(orderForm.get('differentDeliveryAddress')?.value){<div class="row">
          <input 
            type="text" 
            placeholder="Ir√°ny√≠t√≥sz√°m *" 
            class="input" 
            formControlName="shippingZip"
            [class.error]="orderForm.get('differentDeliveryAddress') &&  (orderForm.get('shippingZip')?.invalid && orderForm.get('shippingZip')?.touched)"
          />
          <input 
            type="text" 
            placeholder="Telep√ºl√©s *" 
            class="input" 
            formControlName="shippingCity"
            [class.error]="orderForm.get('differentDeliveryAddress') &&  (orderForm.get('shippingCity')?.invalid && orderForm.get('shippingCity')?.touched)"
          />
        </div>}
        @if(orderForm.get('differentDeliveryAddress')?.value){<div class="row">
          <input 
            type="text" 
            placeholder="Utca, h√°zsz√°m *" 
            class="input" 
            formControlName="shippingAddress"
            [class.error]="orderForm.get('differentDeliveryAddress') && (orderForm.get('shippingAddress')?.invalid && orderForm.get('shippingAddress')?.touched)"
          />
        </div>}

        <div class="row">
          <textarea 
            placeholder="Megjegyz√©s" 
            class="textarea"
            formControlName="deliveryNotes"
          ></textarea>
        </div>



        <!-- Error message -->
        @if(orderError()){<div class="error-message">
          ‚ö†Ô∏è {{ orderError() }}
        </div>}

        <label class="policy">
          <input 
            type="checkbox" 
            formControlName="acceptedPolicy"
          />
          Elfogadom az <a href="/privacy" target="_blank">Adatv√©delmi Nyilatkozatot</a> *
        </label>
        <div class="submit-wrap">
          <button 
            type="submit" 
            class="submit"
            [disabled]="!canSubmitOrder"
          >
            @if(orderLoading()){<span class="loading-spinner"></span>}
            {{ orderLoading() ? 'Rendel√©s lead√°sa...' : 'Rendel√©s lead√°sa' }}
          </button>
        </div>
      </form>
    </div>
  </section>}
</div>